<!doctype html>
<html lang="en">

    <head>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        
        <link rel="icon" href="https://www.petfactory.se/favicons/favicon-32.png" sizes="32x32">

        
        
        
        <link rel="apple-touch-icon" href="https://www.petfactory.se/favicons/favicon-180.png" sizes="180x180">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        
        <link rel="stylesheet" href="https://www.petfactory.se/css/style.css">
        <link rel="stylesheet" href="https://www.petfactory.se/css/syntax.css">
        <link href="https://fonts.googleapis.com/css2?family=Hind:wght@400;500&display=swap" rel="stylesheet">
        <title>Petfactory | Houdini - Crowd</title>
        <meta name="description" content="Petfactory | Design and Animation | Houdini - Crowd" />

    </head>

    <body>

        <div class="site-header"> 

            <div class="container main-nav-wrap">
                 
                <a class="py-2 home-icon" href="https://www.petfactory.se/">
                    <div class="header-logo-wrap">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#e83e8c" width="18" height="18" viewBox="0 0 61.44 61.67"><path class="a" d="M1.28,45.25V56.6a6,6,0,0,0,6,6H18.64A27.07,27.07,0,0,1,8,55.93,25.6,25.6,0,0,1,1.28,45.25Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M28,7.85a27.08,27.08,0,0,1,19.37,7.79L52,20.31,41.35,31,36.9,26.55A13.24,13.24,0,0,0,28,23a12.91,12.91,0,1,0,0,25.82,13.24,13.24,0,0,0,8.9-3.56L62.72,19.42V7.18a6,6,0,0,0-6-6H7.29a6.33,6.33,0,0,0-6,6.23V26.77A28.27,28.27,0,0,1,28,7.85Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M47.36,56.6a27,27,0,0,1-10.24,6.23H56.49a6,6,0,0,0,6-6V41.46Z" transform="translate(-1.28 -1.17)"/></svg>
                        
                    </div>
                </a>

                <nav id="main-nav">
    <ul id="main-menu">
        
        
            
                <li>
                    <a href="https://www.petfactory.se/about">
                        
                        <span>ABOUT</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.petfactory.se/work">
                        
                        <span>WORK</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.petfactory.se/cv">
                        
                        <span>CV</span>
                    </a>
                </li>
            
        
            
                <li class="">
                    <a href="https://www.petfactory.se/notes">  
                        
                        <span>NOTES</span>
                    </a>
                    <ul class="sub-menu">
                        
                            <li class="">
                                <a href="https://www.petfactory.se/tags/python-notes">Python</a>
                            </li>
                        
                            <li class="">
                                <a href="https://www.petfactory.se/tags/houdini-notes">Houdini</a>
                            </li>
                        
                            <li class="">
                                <a href="https://www.petfactory.se/tags/unreal-engine-notes">Unreal Engine</a>
                            </li>
                        
                            <li class="">
                                <a href="https://www.petfactory.se/tags/davinci-resolve-notes">DaVinci Resolve</a>
                            </li>
                        
                    </ul>
                </li>
            
        
    </ul>
</nav>

            </div>
            
        </div>


        <div class="site-header-mobile"> 

            
            <div class="menu-wrap">

                <ul>
                    <li><a class="menu-wrap-a" href="https://www.petfactory.se/about">ABOUT</a></li>
                    <li><a class="menu-wrap-a" href="https://www.petfactory.se/work">WORK</a></li>
                    <li><a class="menu-wrap-a" href="https://www.petfactory.se/cv">CV</a></li>
                    <li><a class="menu-wrap-a" href="https://www.petfactory.se/notes">NOTES</a></li>
                </ul>

                
                
                <div id="social-list-modal-wrap">
                    <ul id="social-list-modal">
                        <li><a target="_blank" class="" href="https://twitter.com/johanBorgstrom"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16"><path d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</a></li>
                        
                        <li><a target="_blank" class="" href="https://www.youtube.com/channel/UCvk7lMI0ihnUr4KSfTlPEfQ"><svg fill="#444" width="20" height="20" viewBox="0 0 64 64"><path d="M54.15,10.031l-20.9-0.019l-21.718,0.019c-5.433,0-11.534,3.626-11.534,8.944v26.474c0,5.316,6.101,8.559,11.534,8.559 H54.15c5.432,0,9.834-3.242,9.834-8.559V18.976C63.984,13.657,59.582,10.031,54.15,10.031z M27.856,42.205L27.73,22.044 l14.03,10.168L27.856,42.205z"/></svg>




</a></li>
                        <li><a target="_blank" class="" href="https://github.com/petfactory"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16"><path d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</a></li>
                        <li><a target="_blank" class="" href="https://linkedin.com/in/johan-borgstr%c3%b6m-8b06875"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></svg></a></li>
                    </ul>
                </div>

            </div>

            <div class="container">

                <a class="py-2 home-icon" href="https://www.petfactory.se/">
                    <div class="header-logo-wrap">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#e83e8c" width="18" height="18" viewBox="0 0 61.44 61.67"><path class="a" d="M1.28,45.25V56.6a6,6,0,0,0,6,6H18.64A27.07,27.07,0,0,1,8,55.93,25.6,25.6,0,0,1,1.28,45.25Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M28,7.85a27.08,27.08,0,0,1,19.37,7.79L52,20.31,41.35,31,36.9,26.55A13.24,13.24,0,0,0,28,23a12.91,12.91,0,1,0,0,25.82,13.24,13.24,0,0,0,8.9-3.56L62.72,19.42V7.18a6,6,0,0,0-6-6H7.29a6.33,6.33,0,0,0-6,6.23V26.77A28.27,28.27,0,0,1,28,7.85Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M47.36,56.6a27,27,0,0,1-10.24,6.23H56.49a6,6,0,0,0,6-6V41.46Z" transform="translate(-1.28 -1.17)"/></svg>
                    </div>
                </a>

                <a href="javascript:void(0);" class="menu-icon">
                    <div class="mobile-menu-trigger">            
                        <svg fill="#fff" width="18" height="18" viewBox="0 0 18 15"><path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/><path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/><path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/></svg>
                    </div>
                </a>

            </div>

        </div>

        <main id="content-main-wrap">

            

<div class="top-spacer"></div>

<div class="container">
	<div class="toc-wrap">
		<aside class="toc-aside">
			<div class="toc-content visible">
				<nav id="TableOfContents">
  <ul>
    <li><a href="#minimal-setup">Minimal Setup</a></li>
    <li><a href="#agent-prim-setup">Agent Prim Setup</a>
      <ul>
        <li><a href="#agent-from-fbx">Agent from FBX</a>
          <ul>
            <li><a href="#agent">Agent</a></li>
            <li><a href="#agent-layer">Agent Layer</a></li>
            <li><a href="#foot-planting">Foot Planting</a></li>
            <li><a href="#agent-definition-cache">Agent Definition Cache</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#crowd-source">Crowd Source</a>
      <ul>
        <li>
          <ul>
            <li><a href="#agent-1">Agent</a></li>
            <li><a href="#foot-planting-1">Foot Planting</a></li>
            <li><a href="#agent-layer-1">Agent Layer</a></li>
            <li><a href="#clip-properties">Clip Properties</a></li>
            <li><a href="#transitions">Transitions</a></li>
            <li><a href="#crowd-source-1">Crowd Source</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#crowd-sim">Crowd Sim</a>
      <ul>
        <li><a href="#dop-network">DOP Network</a>
          <ul>
            <li><a href="#crowd-solver">Crowd Solver</a></li>
            <li><a href="#crowd-object">Crowd Object</a></li>
            <li><a href="#crowd-source-2">Crowd Source</a></li>
            <li><a href="#crowd-state">Crowd State</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#how-to">How To</a>
      <ul>
        <li>
          <ul>
            <li><a href="#test-simulation--crowd-transition">Test Simulation : Crowd Transition</a></li>
            <li><a href="#inspect-footplant-channel">Inspect Footplant Channel</a></li>
            <li><a href="#time-offset-chop-channel">Time Offset CHOP Channel</a></li>
            <li><a href="#inspect-locomotion-channel">Inspect Locomotion Channel</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>	
			</div>
			<div class="toc-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
  <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
</svg></div>
		</aside>	
	</div>

</div>


<div class="container notes-wrap">

	<div class="row">
		
		<div class="col-md-10 mx-auto">
			<h1>Houdini - Crowd</h1>
			<p>
<a href="https://www.sidefx.com/docs/houdini/crowds/index.html" target="_blank" rel="noopener">Houdini 18 crowd docs</a></p>
<p>Theese notes are based on the excellent tutorial by Mikael Pettersen, a little bit of CGWiki and random bits of information I stumble up on.</p>
<h1 id="minimal-setup">Minimal Setup</h1>
<p>Lets setup a minimal but &ldquo;working&rdquo; crowd.</p>
<ul>
<li>First create some geo, bones and capture the geometry.</li>
<li>Then create a subnet to house all the parts we created in the previous step, This is our character rig.</li>
<li>Create a new Geometry node and dive in.</li>
<li>Create an <strong>Agent</strong> node.
<ul>
<li><strong>Agent Name</strong> : give it a name</li>
<li><strong>Input</strong> : we select Character Rig</li>
<li><strong>Character Rig</strong> : point to the subnet we created</li>
</ul>
</li>
<li>Create a <strong>Crowd Source</strong> node and plug in the agent node in the first input.</li>
<li>In the randomize tab we can randomize (duhh) varoius properties</li>
<li>In the second input of the crowd source node we can supply our own points as &ldquo;source&rdquo; for the agents.</li>
</ul>
<h1 id="agent-prim-setup">Agent Prim Setup</h1>
<h2 id="agent-from-fbx">Agent from FBX</h2>
<p>Lets say that we have some fbx files, a <em>rest</em> pose, a <em>walk</em> and a <em>run</em> animation. Lets create an agent primitive from theese files, write them out to disc and then read them back in.</p>
<p>Create a <strong>Geometry</strong> node call it &ldquo;agent_prim&rdquo; and dive in. First we will use the rest pose, to setup some agent layers (shape variations that we the can use in our crowd sim to add variation/randomness). We will only add theese layers to the rest pose, the walk and run files we will just write out the clips (meaning the animation) So lets start with the rest pose setup.</p>
<h3 id="agent">Agent</h3>
<p>Create an 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agent.html" target="_blank" rel="noopener">Agent</a> node and call it &ldquo;rest&rdquo;.</p>
<ul>
<li><strong>Agent</strong>
<ul>
<li><strong>Agent Name</strong> : dude (it is important that we use the same name for all the clips that we setup)</li>
<li><strong>Current Clip</strong> : a name that describes the motion of the rest, clip, walk, run etc.
<ul>
<li><strong>note</strong> that you first must set the Clip Name (located under the &ldquo;Clip&rdquo; section at the lower half of the parms, when this is set the clip name is available in the dropdown)</li>
</ul>
</li>
<li><strong>Input</strong> : FBX</li>
<li><strong>FBX File</strong> : path/to/file.fbx</li>
<li><strong>Converts Units</strong>
<ul>
<li>You might need to check this if the size is off.</li>
</ul>
</li>
<li><strong>Clip</strong>
<ul>
<li><strong>Clip Name</strong> : a name that describes the motion of the rest, clip, walk, run etc.
<ul>
<li><strong>Note</strong> that you must set the same name in the Current Clip parm at the top of the parm list.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Locomotion</strong>
<ul>
<li><strong>Convert to In-Place Animation</strong> : on</li>
<li><strong>Locomotion Node</strong> : The node that &ldquo;drives&rdquo; the rig forward, possibly hips
<ul>
<li>The object inside the Character Rig that controls the locomotion of the character (the node in the character rig that has translation channels that move it forward in space). When Convert to In-Place Animation, Houdini uses this to remove the translation from the character animation to keep the character in place. (The crowd solver node assumes that the agent animation is in-place since it will be attached to a moving particle.)</li>
</ul>
</li>
<li><strong>Locomotion Orient</strong> : try LeftUpLeg_To_LeftLeg (using mocapbiped3)
<ul>
<li>If this parameter and Locomotion Node are specified, the generated <strong>locomotion</strong> transform will also contain rotational information using the vector from the Locomotion Node to the Locomotion Orient node<br>
From cgwiki:
&ldquo;The locomotion stuff can handle changes of direction, but needs more information than just where the hips are. There&rsquo;s a second locomotion parameter on the agent sop for orient, but I couldn&rsquo;t understand why it didn&rsquo;t work when I assigned it the hips again. After chatting with sidefx (and re-reading the docs), this field isn&rsquo;t to read the rotation of the hips. You give it another joint, it constructs a vector from the hips to that joint, and uses that vector to cancel out rotation. In this case I used one of the upper leg joints (LeftUpLeg_To_LeftLeg).&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="agent-layer">Agent Layer</h3>
<p><strong>Note! Only for the rest</strong>. This node creates custom agent layers which can be used to add variations to the look of the agent. A layer specifies an assignment of shapes from the agent’s shape library to transforms in its rig. The shapes can be in the original fbx file or you can specify a SOP path within the houdini file. If you do not want or dont have variations skip this step.</p>
<p><strong>Note</strong> that you can chain multiple Agent Layer nodes to add more layers.</p>
<p>Append an 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agentlayer.html" target="_blank" rel="noopener">Agent Layer</a> node to the Agent node.</p>
<ul>
<li><strong>Agent Layer</strong>
<ul>
<li><strong>Layer Name</strong> : give it a descriptive name</li>
<li><strong>Layer Bindings</strong> : set the number of shapes to add
<ul>
<li><strong>Add Shape</strong> : if this is enabled you can add shapes using a SOP path.
<ul>
<li>Then we could specify which node in the fbx to use to drive it, how to deform it etc.</li>
</ul>
</li>
<li><strong>Shape</strong> : select the shape from inside the fbx file.</li>
<li><strong>Transform Name</strong> : I dont think this needs to be specified if the shape is inside the fbx and already deformed by the rig.
<ul>
<li>specifies which transform the shape should be attatched to.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="foot-planting">Foot Planting</h3>
<p>The reason to use foot planting is to avoid the feet sliding on the ground. We can use an 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agentprep.html" target="_blank" rel="noopener">Agent Prep</a> node to assist us with this. The concept is to use an agent prep node in combination with a CHOP network to detect when the foot should be considered stationary. There are two ways to do this, the first one is based on a speed threshold and the other is based on the distance to the terrain.</p>
<p>We can add the agent prep node before the agents are cached to disc or after (when they are read back in). It is probably better to do this before, since then the data is already present if we read the agent cache in some other setup later.</p>
<p><strong>Note</strong> that we <strong>also</strong> need to add an Agent prep in the &ldquo;crowd_src&rdquo; geometry network to let houdini know which bones that will be part of the IK chaoin that houdini will create to achieve the foot locking. Notes on this will be in the &ldquo;Crowd Source&rdquo; section.</p>
<ul>
<li>Create an <strong>Agent Prep</strong> node and append it to the Agent node (or the Agent Layer mode if you used one)</li>
<li>Switch to the <strong>Additional Channels</strong> tab</li>
<li>Click on the <strong>Create Footplant CHOP Network</strong>
<ul>
<li>This will create a chop network that basically gets all the animation curves from the clip and pipes them back out through a Merge node. What we will do is to add some foot plant channels that will be merged with the other channels and then written out to disk.</li>
</ul>
</li>
<li>Enter the created CHOP network. Now we will create 2 <strong>Foot Plant</strong> chop nodes, one for the ankle and one for the toe.
<ul>
<li>Create a <strong>Foot Plant</strong> chop node, name it &ldquo;ankle_planted&rdquo;</li>
<li><strong>Source</strong> : Agent</li>
<li><strong>Clip Name</strong> : Set the clip name, to the clip we are working on</li>
<li><strong>Transform Name</strong> : From the drop down select the appropriate bone</li>
<li><strong>Channel Name</strong> : By default it is $OS (or set it explicitly) this is the name of the channel that will be created.</li>
<li>Connect it to the merge Node</li>
<li>Repeat the steps above for the toe bone.</li>
<li><strong>Remember</strong> that if you have a left &amp; right side you need to create 4 footplant nodes (a good idea is to suffix theese wit L &amp; R, or whaterver makes ense to you)</li>
<li>To inspect the foot plant channels 
<a href="https://www.petfactory.se/notes/houdini_crowd/#inspect-footplant-channel">do this</a></li>
</ul>
</li>
<li>On the <strong>Additional Channels</strong> of the Agent Prep press <strong>Reload Channels</strong></li>
</ul>
<h3 id="agent-definition-cache">Agent Definition Cache</h3>
<p>Create an 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agentdefinitioncache.html" target="_blank" rel="noopener">Agent Definition Cache</a> and append it to the Agent Prep node (if present). This node will assit us in writing out the agent data to disk, so that we can reuse the data in other scene files.</p>
<p><strong>Note!</strong> for the <strong>rest</strong> agent we will cache everything to disc but for the other clips we only want to cache the <strong>Clips</strong>, as shown below.</p>
<ul>
<li><strong>Agent Definition Cache</strong>
<ul>
<li><strong>Agent Name</strong> : Set this name to match the name set in the Agent node.</li>
<li><strong>Rig</strong> : on | off</li>
<li><strong>Agent Layers</strong> : on | off</li>
<li><strong>Shape Library</strong> : on | off</li>
<li><strong>Clips</strong> : on | <strong>on</strong></li>
<li><strong>Transform Groups</strong> : on | off</li>
</ul>
</li>
</ul>
<p>Press save to disk to cache the agent prim.</p>
<h1 id="crowd-source">Crowd Source</h1>
<p>In this geo network we will load the agents we cached out to disc, add a crowd source and do other preparations of the agent prims to be used as a source in our crowd sim.</p>
<p>Create a <strong>Geometry</strong> node call it &ldquo;crowd_src&rdquo; and dive in.</p>
<h3 id="agent-1">Agent</h3>
<p>Create an 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agent.html" target="_blank" rel="noopener">Agent</a> node.</p>
<ul>
<li><strong>Agent</strong>
<ul>
<li><strong>Agent Name</strong> : select the same name that were used when writing to disc.</li>
<li><strong>Input</strong> : Agent Definition Cache</li>
<li><strong>Current Clip</strong>
<ul>
<li><strong>Note</strong> that you can set the current clip to preview the cached clips</li>
</ul>
</li>
<li><strong>Apply Clip Locomotion</strong> : off</li>
</ul>
</li>
</ul>
<h3 id="foot-planting-1">Foot Planting</h3>
<p>If we want to use the foot planting channels that we setup earlier, before writing the agents to disc we need use an Agent Prep node here aswell.</p>
<ul>
<li>Create an <strong>Agen Prep</strong> node and append it to the Agent node</li>
<li>Click on the + icon on the right side of Lower Limbs multiparm to add as many lower limbs as needed.</li>
<li>Enter the name of the bones that corresponds with the parms
<ul>
<li>Upper Leg</li>
<li>Knee</li>
<li>Ankle</li>
<li>Toe</li>
</ul>
</li>
<li>specify the <strong>Ankle Plant Channel</strong> (the one we wrote to disc earlier)</li>
<li>specify the <strong>Toe Plant Channel</strong> (the one we wrote to disc earlier)</li>
<li><strong>Note</strong> when we enable foot locking (and use a terrain?) we might need to adjust the ankle &amp; toe offset to offset from the terrain.</li>
</ul>
<h3 id="agent-layer-1">Agent Layer</h3>
<p>Note that we could also add layers to our clips here, if we did not do it earlier (before they were cached)</p>
<h3 id="clip-properties">Clip Properties</h3>
<p>The 
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agentclipproperties.html" target="_blank" rel="noopener">Agent Clip Properties</a> node will help us with creating a loop from a specified frame range of a selected animation clip. This SOP creates geometry (which can be attached to a crowd object) describing advanced options for how animation clips should be played back by the crowd solver. Each point in the geometry represents an animation clip, and point attributes describe properties such as a sub-range of frames that should be looped.</p>
<p><strong>Note</strong> that this node will not be part of the &ldquo;main node chain&rdquo; but will be branching of to the side.</p>
<ul>
<li>Create a <strong>Agent Clip Properties</strong> node and append it to the [Agent node, Agent Prep or Agent Layer] (Dont think it matters)</li>
<li>Click the + to the right of <strong>Clips</strong> to add a clip</li>
<li>Select a <strong>Clip Name</strong> from the dropdown</li>
<li>Enable <strong>Loop Range</strong> and set the start and end frames.</li>
<li>You probably want to enable <strong>Blend While Lopoping</strong>, possibly adjust the frames before and after.</li>
<li>Finally we create a <strong>Null</strong> node call it <strong>OUT_clip_prop</strong> and append it to the Agent Clip Properties node.</li>
</ul>
<p><strong>Note</strong> If we want to test the behaviour of our Agent in combination with the Agent Clip Properties node we can use a Test Simulation: Crowd Transition. 
<a href="https://www.petfactory.se/notes/houdini_crowd/#test-simulation--crowd-transition">See here</a></p>
<p><strong>Note</strong> Lets say that we wish to create a new clip from an already existing clip. To do this we can enable the <strong>Clip Name Alias</strong> in the Agent Clip Properties.</p>
<ul>
<li>Add a new clip in the agent clip properties multiparm.</li>
<li>Select the <strong>Clip Name</strong></li>
<li>Then we enable <strong>Clip Name Alias</strong> and enter the name of the clip we wish to create.</li>
<li>Set the lopp range, blending etc.</li>
</ul>
<h3 id="transitions">Transitions</h3>
<p>
<a href="https://www.sidefx.com/docs/houdini/nodes/sop/agentcliptransitiongraph.html" target="_blank" rel="noopener">Agent Clip Transition Graph</a> A crowd object’s clip transition graph may optionally be used to control transitions between states and animation clips. It provides information about which clips are allowed to transition to each other, and where in the clips those transitions should occur. This can be used by the Crowd Transition DOP to delay state transitions until an appropriate point in the current animation clip, and to smoothly blend into the next clip. Additionally, the clip transition graph allows per-clip control over this behavior (which is useful if the transition’s Input State parameter specifies multiple states, or if Randomize Clips is enabled for any of the input states).</p>
<p><strong>Note</strong> If we <strong>Clip Name Alias</strong> in the Agent Clip Properties (which creates a new clip from an existing one), we need to connect the output of the Agent Clip Properties to the third input of the Agent Clip Transition Graph. (To let it know it exists, sine it is not a part of the clips commeing from the &ldquo;agent node chain&rdquo;)</p>
<p>Each point in the clip transition graph geometry represents an animation clip, and each two-point polygon represents a (one-way) transition between the clips. During a state transition, if the points corresponding to the input and output states&rsquo; animation clips are not directly connected, the Crowd Transition DOP will use the shortest path between the two clips.</p>
<p>So lets first create a transition between &ldquo;idle&rdquo; clip to a &ldquo;walk&rdquo; clip.</p>
<ul>
<li>Create an <strong>Agent Clip Transition Graph</strong> and connect the output of the agent chain (before it goes in to a crowd src node) to the first input of the Agent Clip Transition Graph.</li>
<li>Connect the output of the Agent Clip Properties node to third input.</li>
</ul>
<hr>
<ul>
<li><strong>Agent Clip Transition Graph</strong>
<ul>
<li><strong>Transitions</strong>
<ul>
<li><strong>Compute Transition Graph</strong> : off
<ul>
<li>We will do this manually for now</li>
</ul>
</li>
<li><strong>Extra Transitions</strong> : add as many as you need.
<ul>
<li><strong>Clip A</strong> : idle</li>
<li><strong>Clip B</strong> : walk</li>
</ul>
</li>
<li><strong>Transition Regions</strong> : add as many as we need
<ul>
<li>more regions means that the agents have more &ldquo;time windows&rdquo; to react to a state change, meaning they will be able to faster transition into a reqiested state.</li>
</ul>
</li>
<li><strong>Sync Frame A</strong> : 25
<ul>
<li>Specifies a frame in Clip A where the pose is similar to Sync Frame B in Clip B.</li>
<li>As a guideline we can setup one for every second (25 frames)</li>
<li>So the next sync frame, in the second Transition Region (if we add one) should be 50 and the transition region should be set to 50 - 51</li>
</ul>
</li>
<li><strong>Transition Region</strong> : 25 - 26
<ul>
<li>Specifies the range of frames where a transition may begin. This should typically include Sync Frame A.</li>
</ul>
</li>
<li><strong>Sync Frame B</strong>
<ul>
<li>Specifies a frame in Clip B where the pose is similar to Sync Frame A in Clip A.</li>
<li><strong>Note</strong> this frame is the start frame of the loop setup for the clip in the Agent Clip Properties. To set the start frame of the clip, go to the Agent Clip Properties, find the clip and set the <strong>Start Frame</strong> to 1 (or what you need)</li>
</ul>
</li>
<li><strong>Blend Frames</strong> : 6
<ul>
<li>Specifies the length of the transition between the clips.</li>
</ul>
</li>
<li><strong>Show Guide Geometry</strong>: it can be helpful to view this when setting up</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Note</strong> The Test Simulation: Crowd Transition SOP can be used to quickly preview transitions between particular clips before setting up a crowd simulation. 
<a href="https://www.petfactory.se/notes/houdini_crowd/#test-simulation--crowd-transition">See here</a></p>
<p>Finally create a <strong>OUT_transitions</strong> Null node and append to the Agent Clip Transition Graph. We will reference this node from the Crowd Object in our Crowd sim.</p>
<h3 id="crowd-source-1">Crowd Source</h3>
<p>Create a <strong>Crowd Source</strong> node and append it to the Agen Prep node (if we used one otherwise to the Agent node). If we enter a polygon mesh into the second input (of the source node) agents will be scattered on the incomming geo. If we instead hook up points, the points will be used directly.</p>
<ul>
<li><strong>Crowd Source</strong>
<ul>
<li><strong>Setup</strong> : Set some initial attributes, number of agents, distribution, velocity etc.
<ul>
<li><strong>Initial State</strong> : jump (or something else)</li>
<li><strong>Initial Velocity</strong> : 0, 0, 0
<ul>
<li>We do not want a constant velocity, we want to move the agenst with the forward movement in the animation clips.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Randomize</strong> : Do various randomization of the crowd source</li>
</ul>
</li>
</ul>
<p>Finally create a <strong>Null</strong> node, append it to the crowd source and call it <strong>OUT_crowd_src</strong></p>
<h1 id="crowd-sim">Crowd Sim</h1>
<p>Lets create a crowd sim using the agent we just wrote to disc.</p>
<p>As usual in Houdini we will do the simulation in a DOP Network. Note that we can feed the agent to the dop network without using a crowd source node, but then we need to do more manual setting of attributes. For instance setting the state attribute on the agent prim using a point wrangle like: s@state = &lsquo;rest&rsquo;;. The Crowd Source node provides a convenient way of setting initial attributes aswell as randomizing attributes for a more interseting looking sim.</p>
<h2 id="dop-network">DOP Network</h2>
<p>In Object level create a <strong>DOP Network</strong> name it &ldquo;crowd_sim&rdquo; and dive in.</p>
<h3 id="crowd-solver">Crowd Solver</h3>
<p>Create a Crowd Solver and connect it to the Output node.</p>
<ul>
<li><strong>Crowd Solver</strong>
<ul>
<li><strong>Terrain</strong>
<ul>
<li><strong>Enable Foot Locking</strong> : on
<ul>
<li>Enable Show Guide Geometry to preview when footloocking is used.</li>
</ul>
</li>
<li><strong>Enable Terrain Projection</strong> : on
<ul>
<li>Set the source to SOP and set the path.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="crowd-object">Crowd Object</h3>
<p>Create a Crowd Object and connect it to the 1:st Crowd Solver node.</p>
<ul>
<li><strong>Crowd Object</strong>
<ul>
<li><strong>Crowd</strong>
<ul>
<li><strong>Clip Properties</strong>
<ul>
<li><strong>Source</strong> : SOP</li>
<li><strong>Clip Properties</strong> : set the sop path to the OUT_clip_prop null node we created in the crowd_src geo.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="crowd-source-2">Crowd Source</h3>
<p>Create a Crowd Source and connect it to the 2:nd Crowd Solver node.</p>
<ul>
<li><strong>Crowd Source</strong>
<ul>
<li><strong>Source</strong>
<ul>
<li><strong>Geometry Source</strong> : Use Parameter Values</li>
<li><strong>SOP</strong> : set the path to the OUT_crowd_src we created in the crowd_src geo.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="crowd-state">Crowd State</h3>
<p>Create a Crowd State for each state (animation clip). Connect the states to a merge node and connect the merge to the 3:rd Crowd Solver node.</p>
<ul>
<li><strong>Crowd State</strong>
<ul>
<li><strong>Clip Playback</strong>
<ul>
<li><strong>Type</strong> : Locomotive
<ul>
<li>since we converted our animation to in-place animation and want to drive the agents with the locomotion channel</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="how-to">How To</h1>
<h3 id="test-simulation--crowd-transition">Test Simulation : Crowd Transition</h3>
<ul>
<li>Create a (Test Simulation: Crowd Transition)[https://www.sidefx.com/docs/houdini/nodes/sop/testsim_crowdtransition.html]</li>
<li>Connect the <strong>Agent</strong> sop to the first input</li>
<li>if we have an <strong>Agent Clip Transition Graph</strong> node connect it sop to the second input</li>
<li>Connect the <strong>Agent Clip Properties</strong> sop to the fourth input</li>
<li>Specify the <strong>Initial Clip</strong> : idle
<ul>
<li>This is the clip the transition will start from</li>
</ul>
</li>
<li><strong>Clip Sequence</strong> : 1 (or a many as you need) Specifies an ordered sequence of clips to transition to, starting from the Initial Clip.
<ul>
<li><strong>Clip</strong> : walk (or whaterver you need)
<ul>
<li>The name of the animation clip to transition to.</li>
</ul>
</li>
<li><strong>Trigger Frame</strong> : 10 (or whaterver you need)
<ul>
<li>Specifies when to activate the trigger and begin transitioning to this clip.</li>
</ul>
</li>
</ul>
</li>
<li>If we want to test the foot locking, switch to the <strong>Terrain</strong> tab and <strong>Enable Foot Locking</strong></li>
</ul>
<h3 id="inspect-footplant-channel">Inspect Footplant Channel</h3>
<p>In the CHOP network that was created to add the footplant channels</p>
<ul>
<li>create a delete node</li>
<li><strong>Delete</strong> : Non-scoped Channels</li>
<li><strong>Channel Names</strong> : *planted*</li>
<li>Set the display flag to the delete node (an turn off the same on the merge node)</li>
<li>Open the Motion FX View and view the channels</li>
<li>It can be nice to turn on the <strong>Frame Indicator</strong> (<strong>T</strong>) to view the current time in the Motion FX View.</li>
<li>Split the viewport and view the animation in the scene view in sync with the channels in the Motion FX View.</li>
<li><strong>Note</strong> if you want to edit the timing of the footplant channel (or any other channel for that matter) 
<a href="https://www.petfactory.se/notes/houdini_crowd/#time-offset-chop-channel">do this</a></li>
</ul>
<h3 id="time-offset-chop-channel">Time Offset CHOP Channel</h3>
<p>Lets say that we would like to have the ankle locked earlier/later but not adjust the settings of the foot plant chop node. One way to do this is to edit the foot plant channels created by the foot plant chop.</p>
<ul>
<li>Create a <strong>Shift</strong> node and append tp the Foot palnt node.</li>
<li>Create a <strong>Math</strong> node and connect the Shift Node and the Foot plant node.</li>
<li>Set the <strong>Combine CHOPs</strong> : Maximum.</li>
<li>Connect the output of the Math node to the Merge node (and disconnect the footplant)</li>
</ul>
<h3 id="inspect-locomotion-channel">Inspect Locomotion Channel</h3>
<p>If you want to inspect the locomotion curves of an agent (lets say the agent that we use in our &ldquo;crowd_src&rdquo; network) we can do like this:</p>
<ul>
<li>Create a <strong>CHOP</strong> Network (could do this in the same geo network as the agent we wish to examine) and step inside.</li>
<li>Create an <strong>Agent</strong> chop node</li>
<li>Point the SOP path to the Agent SOP node</li>
<li>In the <strong>Clip Name</strong> parm select a clip</li>
<li>Append a <strong>Delete</strong> chop node
<ul>
<li><strong>Delete</strong> : Non-scoped Channels</li>
<li><strong>Channels Names</strong> : *loc*</li>
</ul>
</li>
<li>Remove the display flag from the Agent chop and set it on the Delete chop.</li>
<li>Open the <strong>Motion FX View</strong></li>
</ul>
		
		</div>
	</div>
</div>
	


        </main>

        

        <footer class="container py-5">

            <div class="row">

                <div class="col-md-6 footer-logo-wrap">
                    <a class="py-2 home-icon" href="https://www.petfactory.se/">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#e83e8c" width="18" height="18" viewBox="0 0 61.44 61.67"><path class="a" d="M1.28,45.25V56.6a6,6,0,0,0,6,6H18.64A27.07,27.07,0,0,1,8,55.93,25.6,25.6,0,0,1,1.28,45.25Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M28,7.85a27.08,27.08,0,0,1,19.37,7.79L52,20.31,41.35,31,36.9,26.55A13.24,13.24,0,0,0,28,23a12.91,12.91,0,1,0,0,25.82,13.24,13.24,0,0,0,8.9-3.56L62.72,19.42V7.18a6,6,0,0,0-6-6H7.29a6.33,6.33,0,0,0-6,6.23V26.77A28.27,28.27,0,0,1,28,7.85Z" transform="translate(-1.28 -1.17)"/><path class="a" d="M47.36,56.6a27,27,0,0,1-10.24,6.23H56.49a6,6,0,0,0,6-6V41.46Z" transform="translate(-1.28 -1.17)"/></svg>
                    </a>
                    <span class="footer-logo-lext">petfactory &copy; 2022</span>
                </div>

                <div class="col-md-6 social-list">
                    <ul>
                        <li><a target="_blank" class="" href="https://twitter.com/johanBorgstrom"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16"><path d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</a></li>
                        
                        <li><a target="_blank" class="" href="https://www.youtube.com/channel/UCvk7lMI0ihnUr4KSfTlPEfQ"><svg fill="#444" width="20" height="20" viewBox="0 0 64 64"><path d="M54.15,10.031l-20.9-0.019l-21.718,0.019c-5.433,0-11.534,3.626-11.534,8.944v26.474c0,5.316,6.101,8.559,11.534,8.559 H54.15c5.432,0,9.834-3.242,9.834-8.559V18.976C63.984,13.657,59.582,10.031,54.15,10.031z M27.856,42.205L27.73,22.044 l14.03,10.168L27.856,42.205z"/></svg>




</a></li>
                        <li><a target="_blank" class="" href="https://github.com/petfactory"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16"><path d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</a></li>
                        <li><a target="_blank" class="" href="https://linkedin.com/in/johan-borgstr%c3%b6m-8b06875"><svg fill="#444" width="20" height="20" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></svg></a></li>
                    </ul>
                </div>
            </div>
        </footer>


        
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://www.petfactory.se/js/menu.js"></script>
        
    </body>
</html>